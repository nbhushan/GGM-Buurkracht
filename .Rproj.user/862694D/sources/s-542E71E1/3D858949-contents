#-----clear workspace----
rm(list=ls())

#-----load required packages-----
require(pcalg)    #does all the heavy lifting
#require(SID)     #structural intervention distance
require(qgraph)   #nice visualisation
require(GGally)
require(igraph)

#-----session info-----
sessionInfo()


#-----simulation settings-----
n = 500                 #sample size
p = 4                    #number of parameters
s = 0.7                  #density of the graph, high values denote low graph density
errdist <- "normal"           #c(normal, t, cauchy, or a mix)
z = 4                    #number of latent variables, need to think this through


#-----simulate random DAG based on p and s-----
g <-  pcalg::randomDAG(p, s)

#-----simulate multivariate data from DAG based on n and error distribution-----
gData <- rmvDAG(n, g, errDist = errdist)
corg <- cor(gData)          #sufficient statistics
#ggpairs(data.frame(gData))  #explore dataset

#-----fit Lingam algorithm-----
gLingam <- lingam(gData)


#-----fit PC algorithm----

pc.fit <- pc(suffStat = list(C=corg,n=n), indepTest = gaussCItest, alpha=0.01,
             labels = colnames(gData)) 


#-----fit FCI algorithm-----
fci.fit <- fci(suffStat = list(C=corg,n=n), indepTest=gaussCItest,
               alpha = 0.01, labels = colnames(gData)) 


#visualize results
par(mfrow=c(1,3))
b <- qgraph(pc.fit, layout= a$layout,  theme = 'gray', title="PC")
c <- qgraph(t(gLingam$Bpruned), layout= a$layout,  theme = 'gray', title="LINGAM")
plot(fci.fit, main="FCI")
dev.off()


#save as pdf
pdf("C:\\Users\\p275030\\iCloudDrive\\Documents\\Papers\\CD paper\\IMPS\\travelGrant\\Figures\\cdviz.pdf",width=8,height=4,paper='special') 
par(mfrow=c(1,2))
plot(g, main="TRUTH")
plot(pc.fit, main="PC")
dev.off()

#TODO: retrieve adjacency matrices to calculate
#  1) F score
#  2) SHD
#  3) SID

getAdj<- function(gg){  
  return(as.matrix(as(gg, "amat")))
}